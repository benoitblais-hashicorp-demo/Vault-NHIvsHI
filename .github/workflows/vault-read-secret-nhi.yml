# This workflow is manually triggered via `workflow_dispatch`.
#
# It uses `vault-action` to authenticate against an HCP Vault cluster, read a
# secret from a KV v2 secrets engine, and print the secret value in the job
# output. This is intended as a demonstration of Non-Human Identity (NHI) access to
# Vault secrets from GitHub Actions.
#
# Documentation
# - https://github.com/hashicorp/vault-action
#

name: Vault – Read KV v2 Secret (Non-Human Identity)

on:  # yamllint disable-line rule:truthy
  workflow_dispatch:
    inputs:
      vault_address:
        description: "HCP Vault cluster URL (e.g. https://<id>.vault.hashicorp.cloud:8200)"
        required: true
        type: string
      vault_namespace:
        description: "Vault namespace (default: admin)"
        required: false
        default: "admin"
        type: string
      kv_mount:
        description: "KV v2 mount path (default: secret)"
        required: false
        default: "secret"
        type: string
      secret_path:
        description: "Path to the secret within the KV v2 mount (e.g. myapp/config)"
        required: true
        type: string
      secret_key:
        description: "Key name within the secret to retrieve (e.g. username)"
        required: true
        type: string
      auth_method:
        description: "Vault authentication method (e.g. jwt, token, approle)"
        required: false
        default: "jwt"
        type: string
      auth_path:
        description: "Mount path of the authentication method (e.g. github, jwt)"
        required: false
        default: "github"
        type: string
      vault_role:
        description: "Vault role to use for authentication (e.g. github-actions)"
        required: false
        default: "github-actions"
        type: string

permissions:
  contents: read

jobs:
  read-vault-secret:
    name: Read KV v2 Secret (Non-Human Identity – GitHub OIDC JWT)
    runs-on: ubuntu-latest
    steps:

      - name: Read Secret from HCP Vault
        id: vault
        uses: hashicorp/vault-action@v3
        with:
          url: ${{ inputs.vault_address }}
          namespace: ${{ inputs.vault_namespace }}
          method: ${{ inputs.auth_method }}
          path: ${{ inputs.auth_path }}
          role: ${{ inputs.vault_role }}
          # KV v2 paths require the /data/ infix between the mount and the secret path.
          secrets: |
            ${{ inputs.kv_mount }}/data/${{ inputs.secret_path }} ${{ inputs.secret_key }} | SECRET_VALUE

      - name: Show Secret Value
        # GitHub Actions automatically masks secrets written via vault-action.
        # add-mask ensures the raw value is also masked when echoed explicitly.
        run: |
          echo "::add-mask::${{ steps.vault.outputs.SECRET_VALUE }}"
          echo "Secret retrieved successfully."
          echo "Key   : ${{ inputs.secret_key }}"
          echo "Value : ${{ steps.vault.outputs.SECRET_VALUE }}"
