# This workflow is manually triggered via `workflow_dispatch`.
#
# It uses `vault-action` to authenticate against an HCP Vault cluster using a
# GitHub Personal Access Token (PAT) via Vault's GitHub auth method, read a
# secret from a KV v2 secrets engine, and print the secret value in the job
# output. This is intended as a demonstration of Human Identity (HI) access to
# Vault secrets from GitHub Actions.
#
# Prerequisites:
# - A GitHub PAT with `read:org` scope stored as a repository secret named
#   `VAULT_GITHUB_TOKEN`.
# - A Vault GitHub auth method mounted at the path specified by `auth_path`
#   input, configured to trust the GitHub organisation or user.
#
# Documentation
# - https://github.com/hashicorp/vault-action
# - https://developer.hashicorp.com/vault/docs/auth/github
#

name: Vault – Read KV v2 Secret (Human Identity)

on:  # yamllint disable-line rule:truthy
  workflow_dispatch:
    inputs:
      vault_address:
        description: "HCP Vault cluster URL (e.g. https://<id>.vault.hashicorp.cloud:8200)"
        required: true
        type: string
      vault_namespace:
        description: "Vault namespace (default: admin)"
        required: false
        default: "admin"
        type: string
      auth_path:
        description: "Mount path of the GitHub auth method (default: github-hi)"
        required: false
        default: "github-hi"
        type: string
      kv_mount:
        description: "KV v2 mount path (default: secret)"
        required: false
        default: "secret"
        type: string
      secret_path:
        description: "Path to the secret within the KV v2 mount (e.g. demo/hi-credentials)"
        required: true
        type: string

permissions:
  contents: read

jobs:
  read-vault-secret-hi:
    name: Read KV v2 Secret (Human Identity – GitHub PAT)
    runs-on: ubuntu-latest
    steps:

      - name: Read Secret from HCP Vault (GitHub PAT auth)
        id: vault
        uses: hashicorp/vault-action@v3
        with:
          url: ${{ inputs.vault_address }}
          namespace: ${{ inputs.vault_namespace }}
          method: github
          path: ${{ inputs.auth_path }}
          githubToken: ${{ secrets.VAULT_GITHUB_TOKEN }}
          # The * wildcard retrieves all key/value pairs from the secret.
          # Each key is exposed as a separate output variable (uppercased).
          secrets: |
            ${{ inputs.kv_mount }}/data/${{ inputs.secret_path }} *

      - name: Show Secret Values
        # toJSON prints all outputs from the vault step, including every retrieved key.
        run: |
          echo "All secrets retrieved from ${{ inputs.secret_path }}:"
          echo '${{ toJSON(steps.vault.outputs) }}'
