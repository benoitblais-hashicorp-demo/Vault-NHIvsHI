# This workflow is manually triggered via `workflow_dispatch`.
#
# It uses direct `curl` calls to authenticate against an HCP Vault cluster using
# a GitHub Personal Access Token (PAT) via Vault's GitHub auth method, read a
# secret from a KV v2 secrets engine, and print each key/value pair in plaintext
# in the job output. This is intended as a demonstration of Human Identity (HI)
# access to Vault secrets from GitHub Actions.
#
# The PAT is masked with `::add-mask::` and the Vault token is masked with
# `::add-mask::`. The secret payload is never registered as a masked value, so
# all key/value pairs are printed in plaintext using a `jq to_entries[]` loop.
#
# Prerequisites:
# - A GitHub PAT with `read:org` scope stored as a repository secret named
#   `VAULT_GITHUB_TOKEN`.
# - A Vault GitHub auth method mounted at the path specified by `auth_path`
#   input, configured to trust the GitHub organisation or user.
#
# Documentation
# - https://developer.hashicorp.com/vault/docs/auth/github
#

name: Vault – Read KV v2 Secret (Human Identity)

on:  # yamllint disable-line rule:truthy
  workflow_dispatch:
    inputs:
      vault_address:
        description: "HCP Vault cluster URL (e.g. https://<id>.vault.hashicorp.cloud:8200)"
        required: true
        type: string
      vault_namespace:
        description: "Vault namespace (e.g. admin/nhivshi-demo)"
        required: true
        type: string
      auth_path:
        description: "Mount path of the GitHub auth method (e.g. github-hi)"
        required: true
        type: string
      kv_mount:
        description: "KV v2 mount path (e.g. secret)"
        required: true
        type: string
      secret_path:
        description: "Path to the secret within the KV v2 mount (e.g. demo/hi-credentials)"
        required: true
        type: string

permissions:
  contents: read

jobs:
  read-vault-secret-hi:
    name: Read KV v2 Secret (Human Identity – GitHub PAT)
    runs-on: ubuntu-latest
    steps:

      - name: Login to Vault and Retrieve Secret
        env:
          VAULT_ADDR: ${{ inputs.vault_address }}
          VAULT_NAMESPACE: ${{ inputs.vault_namespace }}
          GITHUB_PAT: ${{ secrets.VAULT_GITHUB_TOKEN }}
        run: |
          echo "::add-mask::$GITHUB_PAT"

          # Exchange the GitHub PAT for a Vault token via the GitHub auth method
          VAULT_TOKEN=$(curl -sS \
            --header "X-Vault-Namespace: $VAULT_NAMESPACE" \
            --request POST \
            --data "{\"token\": \"$GITHUB_PAT\"}" \
            "$VAULT_ADDR/v1/auth/${{ inputs.auth_path }}/login" \
            | jq -r '.auth.client_token')
          echo "::add-mask::$VAULT_TOKEN"

          # Read the secret from KV v2 and iterate over every key/value pair
          # Nothing is registered with ::add-mask:: so all values print in plaintext
          SECRET_DATA=$(curl -sS \
            --header "X-Vault-Token: $VAULT_TOKEN" \
            --header "X-Vault-Namespace: $VAULT_NAMESPACE" \
            "$VAULT_ADDR/v1/${{ inputs.kv_mount }}/data/${{ inputs.secret_path }}" \
            | jq -r '.data.data')

          echo "Secret data retrieved from ${{ inputs.kv_mount }}/data/${{ inputs.secret_path }}:"
          echo "$SECRET_DATA" | jq -r 'to_entries[] | "  \(.key) = \(.value)"'
