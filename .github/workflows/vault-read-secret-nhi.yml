# This workflow is manually triggered via `workflow_dispatch`.
#
# It uses direct `curl` calls to authenticate against an HCP Vault cluster using
# a short-lived GitHub OIDC token via Vault's JWT auth method, read a secret from
# a KV v2 secrets engine, and print each key/value pair in plaintext in the job
# output. This is intended as a demonstration of Non-Human Identity (NHI) access
# to Vault secrets from GitHub Actions.
#
# The OIDC token is masked with `::add-mask::` and the Vault token is masked with
# `::add-mask::`. The secret payload is never registered as a masked value, so
# all key/value pairs are printed in plaintext using a `jq to_entries[]` loop.
#
# Prerequisites:
# - The workflow must have `id-token: write` permission to request an OIDC token.
# - A Vault JWT auth method mounted at the path specified by `auth_path` input,
#   configured with `bound_audiences` matching the `jwt_audience` input.
#
# Documentation
# - https://developer.hashicorp.com/vault/docs/auth/jwt
# - https://docs.github.com/en/actions/security-for-github-actions/security-hardening-your-deployments/about-security-hardening-with-openid-connect
#

name: Vault – Read KV v2 Secret (Non-Human Identity)

on:  # yamllint disable-line rule:truthy
  workflow_dispatch:
    inputs:
      vault_address:
        description: "HCP Vault cluster URL (e.g. https://<id>.vault.hashicorp.cloud:8200)"
        required: true
        type: string
      vault_namespace:
        description: "Vault namespace (default: admin)"
        required: false
        default: "admin/nhivshi-demo"
        type: string
      kv_mount:
        description: "KV v2 mount path (default: secret)"
        required: false
        default: "secret"
        type: string
      secret_path:
        description: "Path to the secret within the KV v2 mount (e.g. myapp/config)"
        required: false
        default: "demo/nhi-credentials"
        type: string
      auth_path:
        description: "Mount path of the authentication method (e.g. github, jwt)"
        required: false
        default: "github"
        type: string
      vault_role:
        description: "Vault role to use for authentication (e.g. github-actions)"
        required: false
        default: "github-actions"
        type: string
      jwt_audience:
        description: "Audience claim set on the GitHub OIDC token — must match bound_audiences in the Vault JWT role (default: https://vault.hashicorp.cloud)"
        required: false
        default: "https://vault.hashicorp.cloud"
        type: string

permissions:
  contents: read
  id-token: write  # Required for GitHub Actions to request an OIDC token for JWT auth

jobs:
  read-vault-secret:
    name: Read KV v2 Secret (Non-Human Identity – GitHub OIDC JWT)
    runs-on: ubuntu-latest
    steps:

      - name: Request GitHub OIDC Token
        id: oidc
        run: |
          OIDC_TOKEN=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${{ inputs.jwt_audience }}" \
            | jq -r '.value')
          echo "::add-mask::$OIDC_TOKEN"
          echo "oidc_token=$OIDC_TOKEN" >> "$GITHUB_OUTPUT"

      - name: Login to Vault and Retrieve Secret
        env:
          VAULT_ADDR: ${{ inputs.vault_address }}
          VAULT_NAMESPACE: ${{ inputs.vault_namespace }}
        run: |
          # Exchange the GitHub OIDC token for a Vault token via JWT auth
          VAULT_TOKEN=$(curl -sS \
            --header "X-Vault-Namespace: $VAULT_NAMESPACE" \
            --request POST \
            --data "{\"jwt\": \"${{ steps.oidc.outputs.oidc_token }}\", \"role\": \"${{ inputs.vault_role }}\"}" \
            "$VAULT_ADDR/v1/auth/${{ inputs.auth_path }}/login" \
            | jq -r '.auth.client_token')
          echo "::add-mask::$VAULT_TOKEN"

          # Read the secret from KV v2 and iterate over every key/value pair
          # Nothing is registered with ::add-mask:: so all values print in plaintext
          SECRET_DATA=$(curl -sS \
            --header "X-Vault-Token: $VAULT_TOKEN" \
            --header "X-Vault-Namespace: $VAULT_NAMESPACE" \
            "$VAULT_ADDR/v1/${{ inputs.kv_mount }}/data/${{ inputs.secret_path }}" \
            | jq -r '.data.data')

          echo "Secret data retrieved from ${{ inputs.kv_mount }}/data/${{ inputs.secret_path }}:"
          echo "$SECRET_DATA" | jq -r 'to_entries[] | "  \(.key) = \(.value)"'
