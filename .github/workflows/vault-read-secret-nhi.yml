# This workflow is manually triggered via `workflow_dispatch`.
#
# It uses `vault-action` to authenticate against an HCP Vault cluster, read a
# secret from a KV v2 secrets engine, and print the secret value in the job
# output. This is intended as a demonstration of Non-Human Identity (NHI) access to
# Vault secrets from GitHub Actions.
#
# Documentation
# - https://github.com/hashicorp/vault-action
#

name: Vault – Read KV v2 Secret (Non-Human Identity)

on:  # yamllint disable-line rule:truthy
  workflow_dispatch:
    inputs:
      vault_address:
        description: "HCP Vault cluster URL (e.g. https://<id>.vault.hashicorp.cloud:8200)"
        required: true
        type: string
      vault_namespace:
        description: "Vault namespace (default: admin)"
        required: false
        default: "admin/nhivshi-demo"
        type: string
      kv_mount:
        description: "KV v2 mount path (default: secret)"
        required: false
        default: "secret"
        type: string
      secret_path:
        description: "Path to the secret within the KV v2 mount (e.g. myapp/config)"
        required: false
        default: "demo/nhi-credentials"
        type: string
      auth_method:
        description: "Vault authentication method (e.g. jwt, token, approle)"
        required: false
        default: "jwt"
        type: string
      auth_path:
        description: "Mount path of the authentication method (e.g. github, jwt)"
        required: false
        default: "github"
        type: string
      vault_role:
        description: "Vault role to use for authentication (e.g. github-actions)"
        required: false
        default: "github-actions"
        type: string
      jwt_audience:
        description: "Audience claim set on the GitHub OIDC token — must match bound_audiences in the Vault JWT role (default: https://vault.hashicorp.cloud)"
        required: false
        default: "https://vault.hashicorp.cloud"
        type: string

permissions:
  contents: read
  id-token: write  # Required for GitHub Actions to request an OIDC token for JWT auth

jobs:
  read-vault-secret:
    name: Read KV v2 Secret (Non-Human Identity – GitHub OIDC JWT)
    runs-on: ubuntu-latest
    steps:

      - name: Read Secret from HCP Vault
        id: vault
        uses: hashicorp/vault-action@v3
        with:
          url: ${{ inputs.vault_address }}
          namespace: ${{ inputs.vault_namespace }}
          method: ${{ inputs.auth_method }}
          path: ${{ inputs.auth_path }}
          role: ${{ inputs.vault_role }}
          jwtGithubAudience: ${{ inputs.jwt_audience }}
          # The * wildcard retrieves all key/value pairs from the secret.
          # Each key is exposed as a separate output variable (uppercased).
          secrets: |
            ${{ inputs.kv_mount }}/data/${{ inputs.secret_path }} *

      - name: Show Secret Values
        # toJSON prints all outputs from the vault step, including every retrieved key.
        run: |
          echo "All secrets retrieved from ${{ inputs.secret_path }}:"
          echo '${{ toJSON(steps.vault.outputs) }}'
